<html>
<meta charset="utf-8" />
<head>
<title>WebSocket Test</title>
<style type="text/css">
.info {
 color: #01529B;
 background-color: #BDE5F8;
}
.error {
 color: #D8000C;
 background-color: #FFBABA;
}
.warning {
 color: #9F6000;
 background-color: #FEEFB3;
}
.button{
    font: 11px verdana, arial, helvetica, sans-serif;
    border: 1px solid #ccc;
    color: #666;
    font-weight: bold;
    font-size: 10px;
    margin-top: 5px;
    overflow: hidden;
}


</style>
</head>
<body>
<h3>Ranger Web</h3>

<form id="query" name="query">
  <textarea name="display">
unique_request_id
uri
  </textarea>
  <input type="button" value="Update Query" id="queryButton" name="queryButton" />
</form>

<input type="button" value="stop" id="stopButton" class="button" />


<div id="output">
</div>


<span class="warning">Behold websockets</span>


</body>
<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAALkkVYi-_IoTqjN6A5Vej_RSP7reJNzDv1559unVybm5vtiJlwRR-YypmmY-UrlkmztE53h7rMSoPwg"></script>
<script type="text/javascript" language="javascript">
  google.load("jquery", "1.6.2");
</script>

<script language="javascript" type="text/javascript">
  var RW = RW || {};

  RW.init = function() {
      $('#queryButton').click(RW.onQueryClick);
      $('#stopButton').click(RW.onStopClick);
  };

  RW.currentStream = null;

  RW.onQueryClick = function(evt) {
      console.log("Query!");
      
      if (RW.currentStream) {
        RW.currentStream.stop();
      }

      RW.currentStream = new RW.RangerStream(RW.createQuery());
      
  };

  RW.onStopClick = function(evt) {
    if (RW.currentStream) {
      RW.currentStream.stop();  
    }
  };

  RW.createQuery = function() {
    return null;
  }

  RW.RangerStream = function(query) {
      var rangerStream = this;
      this.output = document.getElementById("output");
      this.output.innerHTML = "";
      
      this.websocket = new WebSocket("ws://localhost:"+8080+"/ws");
      this.websocket.onopen = function(evt) { rangerStream.onOpen(evt) };
      this.websocket.onclose = function(evt) { rangerStream.onClose(evt) };
      this.websocket.onmessage = function(evt) { rangerStream.onMessage(evt) };
      this.websocket.onerror = function(evt) { rangerStream.onError(evt) };        
  };

  RW.RangerStream.prototype.stop = function() {
      this.websocket.close();
      this.output = null;
  };

  RW.RangerStream.prototype.onOpen = function(evt) {
    console.log("connected");
  };

  RW.RangerStream.prototype.onClose = function(evt) {
      console.log('now closed');
      this.writeToScreen("...Kaboom...Im gone",'warning');
  };


  RW.RangerStream.prototype.onMessage = function(evt) {
      var rangerStream = this;
      console.log("received: " + evt.data);
      var obj = $.parseJSON(evt.data);
      $.each(obj, function(key, value) {
          rangerStream.writeToScreen(key + " : " + value);
      });
      this.writeToScreen("");
  }

  RW.RangerStream.prototype.onError = function(evt) {
      console.log("error: " + evt);
      this.writeToScreen(evt.data,'error');
  }

  RW.RangerStream.prototype.doSend = function(message) {
      this.writeToScreen("SENT: " + message); 
      this.websocket.send(message);
  }

  RW.RangerStream.prototype.writeToScreen = function(message, rule) {
      if (this.output) {
        this.output.innerHTML = message + "<br />" + output.innerHTML;
        this.output.className=rule;        
      }
  }
  
  
  $(document).ready(RW.init);
</script>
</html>