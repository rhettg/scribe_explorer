<html>
<meta charset="utf-8" />
<head>
<title>WebSocket Test</title>
<style type="text/css">
.info {
 color: #01529B;
 background-color: #BDE5F8;
}
.error {
 color: #D8000C;
 background-color: #FFBABA;
}
.warning {
 color: #9F6000;
 background-color: #FEEFB3;
}
.button{
    font: 11px verdana, arial, helvetica, sans-serif;
    border: 1px solid #ccc;
    color: #666;
    font-weight: bold;
    font-size: 10px;
    margin-top: 5px;
    overflow: hidden;
}


</style>
</head>
<body>
<h3>Ranger Web</h3>

<form id="query" name="query">
  <textarea id="displayFields">
unique_request_id
uri
  </textarea>
  <textarea id="queryFilters">
  </textarea>

  <input type="button" value="Update Query" id="queryButton" name="queryButton" />
</form>

<input type="button" value="stop" id="stopButton" class="button" />

<div id="output">
</div>

</body>

<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAALkkVYi-_IoTqjN6A5Vej_RSP7reJNzDv1559unVybm5vtiJlwRR-YypmmY-UrlkmztE53h7rMSoPwg"></script>
<script type="text/javascript" language="javascript">
  google.load("jquery", "1.6.2");
</script>
<script type="text/javascript" src="http://www.datatables.net/release-datatables/media/js/jquery.dataTables.js"></script>


<script language="javascript" type="text/javascript">
  var RW = RW || {};

  RW.init = function() {
      $('#queryButton').click(RW.onQueryClick);
      $('#stopButton').click(RW.onStopClick);
  };

  RW.currentStream = null;

  RW.onQueryClick = function(evt) {
      console.log("Query!");
      
      if (RW.currentStream) {
        RW.currentStream.stop();
      }

      RW.currentStream = new RW.RangerStream(RW.createQuery());
      
  };

  RW.onStopClick = function(evt) {
    if (RW.currentStream) {
      RW.currentStream.stop();  
    }
  };

  RW.createQuery = function() {
    var fieldSplit = $('#displayFields').val().split(/\n/);
    var query = {fields: [], filters: []}
    for (var i in fieldSplit) {
      var field = fieldSplit[i].replace(/\s+/, "");
      if (field) {
        query.fields.push(field)
      }
    }

    var filterSplit = $('#queryFilters').val().split(/\n/);
    for (var i in filterSplit) {
      var filter = filterSplit[i].replace(/\s+/, "");
      if (filter) {
        query.filters.push(filter)
      }
    }

    return query;
  }

  RW.RangerStream = function(query) {
      console.log(query);
      var rangerStream = this;
      this.query = query;
      this.output = document.getElementById("output");
      this.output.innerHTML = "<table id=\'outputTable'\></table>";

      this.keys = query.fields;

      $('#outputTable').append("<thead><tr id='outputTableHeader'></th></tr></thead>");
      for (var ndx in this.keys) {
        $('#outputTableHeader').append("<th>" + this.keys[ndx] + "</th>");  
      }      

      $('#outputTable').append("<tbody id='outputTableBody'></tbody>");
      
      this.websocket = new WebSocket("ws://localhost:"+8080+"/ws");
      this.websocket.onopen = function(evt) { rangerStream.onOpen(evt) };
      this.websocket.onclose = function(evt) { rangerStream.onClose(evt) };
      this.websocket.onmessage = function(evt) { rangerStream.onMessage(evt) };
      this.websocket.onerror = function(evt) { rangerStream.onError(evt) };
      
      this.rowLimit = 20;

  };

  RW.RangerStream.prototype.stop = function() {
      this.websocket.close();
      this.output = null;
  };

  RW.RangerStream.prototype.onOpen = function(evt) {
    console.log("connected");
    this.websocket.send(JSON.stringify(this.query) + '\n');
  };

  RW.RangerStream.prototype.onClose = function(evt) {
      console.log('now closed');
  };


  RW.RangerStream.prototype.onMessage = function(evt) {
      var rangerStream = this;
      console.log("received: " + evt.data);
      var obj = $.parseJSON(evt.data);
      
      var content = "<tr>"
      for (var ndx in this.keys) {
        var val = obj[this.keys[ndx]];
        content += "<td>" + val + "</td>"
      }
      content += "</tr>"
      
      $('#outputTableBody').prepend(content)
      if (this.rowLimit > 0) {
        this.rowLimit -= 1;
      }
      else {
        $('#outputTableBody tr:last-child').remove();
      }
  }

  RW.RangerStream.prototype.onError = function(evt) {
      console.log("error: " + evt);
  }

  $(document).ready(RW.init);
</script>
</html>